-- Auto-buy specific pets script (Delta executor)
-- Konfigurasi:
local TARGET_NAMES = {"peacock"}          -- nama/keyword pet (case-insensitive). Bisa masukkan beberapa.
local MAX_PRICE = 15                     -- maksimal token untuk membeli
local SERVER_HOP = true                   -- apakah akan pindah server bila tidak ditemukan
local PLACE_ID = game.PlaceId             -- biasanya tidak perlu diubah
local REQUEST_LIMIT = 100                 -- berapa banyak server per request (Roblox API limit)
local WAIT_BETWEEN_SCANS = 3              -- detik tunggu tiap scan sebelum serverhop/scan ulang
local REQUEST_TIMEOUT = 10                -- timeout untuk HTTP requests

-- INTERNAL
local HttpService = game:GetService("HttpService")
-- Cleaned & Delta-friendly version of your script
-- No webhooks, no automatic stealing/gifting, no external HTTP requests

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local LocalizationService = game:GetService("LocalizationService")

local DataService = (RS:FindFirstChild("Modules") and require(RS.Modules.DataService)) or nil
local PetRegistry = (RS:FindFirstChild("Data") and require(RS.Data.PetRegistry)) or nil
local NumberUtil = (RS:FindFirstChild("Modules") and require(RS.Modules.NumberUtil)) or nil
local PetUtilities = (RS:FindFirstChild("Modules") and RS.Modules.PetServices and require(RS.Modules.PetServices.PetUtilities)) or nil
local PetsService = (RS:FindFirstChild("Modules") and RS.Modules.PetServices and require(RS.Modules.PetServices.PetsService)) or nil

local LocalPlayer = Players.LocalPlayer

-- Safe executor detection (non-invasive)
local function detectExecutor()
    local ok, name = pcall(function()
        if identifyexecutor then return identifyexecutor() end
        if getexecutorname then return getexecutorname() end
        if syn and syn.get_executor then return syn.get_executor() end
    end)
    return (ok and name) and tostring(name) or "Unknown"
end

local function formatNumberWithCommas(n)
    local s = tostring(n)
    local minus = s:sub(1,1) == "-" and "-" or ""
    if minus == "-" then s = s:sub(2) end
    local int, frac = s:match("^(%d+)[.]?(%d*)$")
    int = int:reverse():gsub("(%d%d%d)", "%1,"):reverse():gsub("^,", "")
    if frac and frac ~= "" then
        return minus .. int .. "." .. frac
    else
        return minus .. int
    end
end

local function getWeight(toolName)
    if not toolName or toolName == "No Tool" then return nil end
    local weight = toolName:match("%[([%d%.]+) KG%]")
    return weight and tonumber(weight) or nil
end

local function getAge(toolName)
    if not toolName or toolName == "No Tool" then return nil end
    local age = toolName:match("%[Age (%d+)%]")
    return age and tonumber(age) or nil
end

-- Pet priority data (used only for display sorting)
local PetPriorityData = {
    ["Kitsune"] = { priority = 1, emoji = "ðŸ¦Š" },
    ["Raccoon"] = { priority = 2, emoji = "ðŸ¦" },
    ["Peacock"] = { priority = 29, emoji = "â„ï¸" },
    ["T-Rex"] = { priority = 9, emoji = "ðŸ¦–" },
    ["Rainbow Elephant"] = { priority = 97, emoji = "ðŸ—¿" },
    -- add more entries if desired (harmless metadata)
}

local function SafeCalculatePetValue(tool)
    -- Non-throwing calculation that uses DataService/PetRegistry if available.
    local ok, result = pcall(function()
        if not DataService or not PetRegistry or not NumberUtil or not PetUtilities then
            return 0
        end
        local PET_UUID = tool:GetAttribute("PET_UUID") or tool:GetAttribute("uuid")
        if not PET_UUID then return 0 end
        local data = DataService:GetData()
        if not data or not data.PetsData or not data.PetsData.PetInventory or not data.PetsData.PetInventory.Data then
            return 0
        end
        local petInventoryData = data.PetsData.PetInventory.Data[PET_UUID]
        if not petInventoryData then return 0 end
        local petData = petInventoryData.PetData
        local HatchedFrom = petData.HatchedFrom
        if not HatchedFrom or HatchedFrom == "" then return 0 end
        local eggData = PetRegistry.PetEggs[HatchedFrom]
        if not eggData then return 0 end
        local rarityData = eggData.RarityData.Items[petInventoryData.PetType]
        if not rarityData then return 0 end
        local WeightRange = rarityData.GeneratedPetData.WeightRange
        if not WeightRange then return 0 end
        local sellPrice = PetRegistry.PetList[petInventoryData.PetType].SellPrice or 0
        local weightMultiplier = math.lerp(0.8, 1.2, NumberUtil.ReverseLerp(WeightRange[1], WeightRange[2], petData.BaseWeight))
        local levelMultiplier = math.lerp(0.15, 6, PetUtilities:GetLevelProgress(petData.Level))
        return math.floor(sellPrice * weightMultiplier * levelMultiplier)
    end)
    if ok then return result end
    return 0
end

local function GetPlayerPets()
    local result = {}
    if not LocalPlayer then return result end

    local player = LocalPlayer
    -- Unequip temporarily if PetsPhysical used (safe attempt)
    if workspace:FindFirstChild("PetsPhysical") then
        for _, petMover in pairs(workspace.PetsPhysical:GetChildren()) do
            if petMover and petMover:GetAttribute and petMover:GetAttribute("OWNER") == player.Name then
                for _, pet in pairs(petMover:GetChildren()) do
                    if PetsService and type(PetsService.UnequipPet) == "function" then
                        pcall(function() PetsService:UnequipPet(pet.Name) end)
                    end
                end
            end
        end
    end

    task.wait(0.3)

    for _, tool in pairs(player.Backpack:GetChildren()) do
        if tool and tool:IsA("Tool") and tool:GetAttribute("ItemType") == "Pet" then
            local petName = tool.Name
            local age = getAge(tool.Name) or 0
            local weight = getWeight(tool.Name) or 0
            local strippedName = petName:gsub(" %[.*%]", "")

            local rawValue = SafeCalculatePetValue(tool) or 0
            table.insert(result, {
                PetName = petName,
                PetAge = age,
                PetWeight = weight,
                Id = tool:GetAttribute("PET_UUID") or tool:GetAttribute("uuid"),
                Type = strippedName,
                Value = rawValue,
                Formatted = formatNumberWithCommas(rawValue),
                ToolRef = tool
            })
        end
    end

    -- re-equip none (we didn't change player's equipped tools beyond safe unequip attempts)
    return result
end

-- Sort by Value descending, then priority if available
local function sortPets(pets)
    table.sort(pets, function(a, b)
        local aPr = (PetPriorityData[a.Type] and PetPriorityData[a.Type].priority) or 999
        local bPr = (PetPriorityData[b.Type] and PetPriorityData[b.Type].priority) or 999
        if aPr == bPr then
            return a.Value > b.Value
        else
            return aPr < bPr
        end
    end)
end

-- GUI: show pets + allow user to choose recipient and gift (user-triggered)
local function CreateSafeGui()
    if not LocalPlayer then return end
    local playerGui = LocalPlayer:FindFirstChild("PlayerGui") or LocalPlayer:WaitForChild("PlayerGui")

    -- Prevent duplicate GUI
    local existing = playerGui:FindFirstChild("SafePetGui")
    if existing then existing:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "SafePetGui"
    gui.ResetOnSpawn = false
    gui.Parent = playerGui
    gui.DisplayOrder = 9999

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 520, 0, 380)
    frame.Position = UDim2.new(0.5, -260, 0.5, -190)
    frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    frame.BorderSizePixel = 0
    frame.Parent = gui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 36)
    title.Position = UDim2.new(0,0,0,0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextColor3 = Color3.fromRGB(255,255,255)
    title.Text = "Safe Pet Manager (Delta-friendly)"
    title.Parent = frame

    -- Pet list scrolling frame
    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = UDim2.new(1, -20, 0, 260)
    scroll.Position = UDim2.new(0, 10, 0, 46)
    scroll.CanvasSize = UDim2.new(0, 0, 1, 0)
    scroll.BackgroundTransparency = 0.8
    scroll.BorderSizePixel = 0
    scroll.Parent = frame
    scroll.ScrollBarThickness = 6

    local uiLayout = Instance.new("UIListLayout")
    uiLayout.Padding = UDim.new(0, 6)
    uiLayout.Parent = scroll

    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(1, -20, 0, 28)
    infoLabel.Position = UDim2.new(0, 10, 0, 316)
    infoLabel.BackgroundTransparency = 1
    infoLabel.TextColor3 = Color3.fromRGB(200,200,200)
    infoLabel.Font = Enum.Font.Gotham
    infoLabel.TextSize = 14
    infoLabel.Text = "Select a pet, choose a player, then press 'Gift Selected Pet' to gift (user action required)."
    infoLabel.Parent = frame

    local recipientDropdown = Instance.new("TextLabel")
    recipientDropdown.Size = UDim2.new(0.5, -15, 0, 28)
    recipientDropdown.Position = UDim2.new(0, 10, 0, 346)
    recipientDropdown.BackgroundTransparency = 0.9
    recipientDropdown.TextColor3 = Color3.fromRGB(255,255,255)
    recipientDropdown.Font = Enum.Font.Gotham
    recipientDropdown.TextSize = 14
    recipientDropdown.Text = "Recipient: (none)"
    recipientDropdown.Parent = frame

    local refreshPlayersBtn = Instance.new("TextButton")
    refreshPlayersBtn.Size = UDim2.new(0, 120, 0, 28)
    refreshPlayersBtn.Position = UDim2.new(0.5, 10, 0, 346)
    refreshPlayersBtn.Text = "Refresh Players"
    refreshPlayersBtn.Font = Enum.Font.GothamSemibold
    refreshPlayersBtn.TextSize = 14
    refreshPlayersBtn.Parent = frame

    local giftBtn = Instance.new("TextButton")
    giftBtn.Size = UDim2.new(0, 160, 0, 36)
    giftBtn.Position = UDim2.new(1, -170, 0, 342)
    giftBtn.Text = "Gift Selected Pet"
    giftBtn.Font = Enum.Font.GothamBold
    giftBtn.TextSize = 16
    giftBtn.Parent = frame

    -- Populate player selection
    local recipients = {}
    local selectedRecipient = nil
    local selectedPet = nil

    local function refreshPlayerList()
        recipients = {}
        for _, pl in ipairs(Players:GetPlayers()) do
            if pl ~= LocalPlayer then
                table.insert(recipients, pl)
            end
        end
        if #recipients == 0 then
            recipientDropdown.Text = "Recipient: (none)"
            selectedRecipient = nil
        else
            recipientDropdown.Text = "Recipient: " .. recipients[1].Name
            selectedRecipient = recipients[1]
        end
    end

    refreshPlayersBtn.MouseButton1Click:Connect(function()
        refreshPlayerList()
    end)

    refreshPlayerList()

    -- Fill pet list
    local pets = GetPlayerPets()
    sortPets(pets)

    for i, pet in ipairs(pets) do
        local b = Instance.new("TextButton")
        b.Size = UDim2.new(1, -10, 0, 36)
        b.BackgroundColor3 = Color3.fromRGB(40,40,40)
        b.TextColor3 = Color3.fromRGB(230,230,230)
        b.Font = Enum.Font.Gotham
        b.TextSize = 14
        b.AutoButtonColor = true
        b.Text = (PetPriorityData[pet.Type] and PetPriorityData[pet.Type].emoji or "ðŸ¶") .. "  " .. pet.PetName .. "  â†’  " .. (pet.Formatted or "0")
        b.Parent = scroll

        b.MouseButton1Click:Connect(function()
            selectedPet = pet
            for _, child in pairs(scroll:GetChildren()) do
                if child:IsA("TextButton") then
                    child.BackgroundColor3 = Color3.fromRGB(40,40,40)
                end
            end
            b.BackgroundColor3 = Color3.fromRGB(70,70,70)
        end)
    end

    -- Allow clicking recipient label to cycle through recipients
    recipientDropdown.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            if #recipients == 0 then return end
            -- cycle
            local idx = 1
            for i, pl in ipairs(recipients) do
                if pl == selectedRecipient then idx = i; break end
            end
            idx = (idx % #recipients) + 1
            selectedRecipient = recipients[idx]
            recipientDropdown.Text = "Recipient: " .. (selectedRecipient and selectedRecipient.Name or "(none)")
        end
    end)

    local function confirmAndGift()
        if not selectedPet then
            warn("No pet selected")
            return
        end
        if not selectedRecipient then
            warn("No recipient selected")
            return
        end

        -- Confirm with user (simple confirmation prompt)
        local confirmed = false
        local conFrame = Instance.new("Frame")
        conFrame.Size = UDim2.new(0, 360, 0, 120)
        conFrame.Position = UDim2.new(0.5, -180, 0.5, -60)
        conFrame.BackgroundColor3 = Color3.fromRGB(30,30,30)
        conFrame.Parent = gui

        local conText = Instance.new("TextLabel")
        conText.Size = UDim2.new(1, -20, 0, 60)
        conText.Position = UDim2.new(0,10,0,10)
        conText.BackgroundTransparency = 1
        conText.TextColor3 = Color3.fromRGB(230,230,230)
        conText.Font = Enum.Font.Gotham
        conText.TextSize = 15
        conText.Text = ("Gift '%s' to %s?"):format(selectedPet.PetName, selectedRecipient.Name)
        conText.Parent = conFrame

        local yes = Instance.new("TextButton")
        yes.Size = UDim2.new(0, 140, 0, 32)
        yes.Position = UDim2.new(0, 30, 1, -42)
        yes.Text = "Yes, Gift"
        yes.Parent = conFrame

        local no = Instance.new("TextButton")
        no.Size = UDim2.new(0, 140, 0, 32)
        no.Position = UDim2.new(1, -170, 1, -42)
        no.Text = "Cancel"
        no.Parent = conFrame

        yes.MouseButton1Click:Connect(function()
            confirmed = true
            conFrame:Destroy()
            -- Perform gifting (user-initiated)
            if RS.GameEvents and RS.GameEvents.PetGiftingService then
                local ok, err = pcall(function()
                    RS.GameEvents.PetGiftingService:FireServer("GivePet", selectedRecipient)
                end)
                if not ok then
                    warn("Gift failed:", err)
                else
                    warn("Gift request sent (server handles result).")
                end
            else
                warn("PetGiftingService not available in this place.")
            end
        end)

        no.MouseButton1Click:Connect(function()
            confirmed = false
            conFrame:Destroy()
        end)
    end

    giftBtn.MouseButton1Click:Connect(function()
        confirmAndGift()
    end)
end

-- Run
CreateSafeGui()

print("Safe Pet Manager loaded. Executor:", detectExecutor())
